@model IEnumerable<POYA.Areas.FunFiles.Models.FunDir>
@using POYA.Areas.FunFiles.Controllers;

@{
    ViewData["Title"] =Localizer[ "Folder"]+" & "+Localizer["Files"];
    Layout = "~/Views/Shared/_Layout.cshtml";
    
    var ParentDirId=Guid.Parse(ViewData["ParentDirId"].ToString());
}

<h1>@(ViewData["Title"])</h1>

<p>
    <a class="btn btn-outline-info" asp-action="Create" asp-route-ParentDirId='@(ParentDirId)'>@(Localizer["New directory"])</a>
    <a class="btn btn-outline-info" asp-action="FunUploadFiles" asp-controller='FunYourFiles' asp-route-ParentDirId='@(ParentDirId)'>
        @(Localizer["Upload files"])
    </a>

    <nav aria-label="breadcrumb" class="PathBreadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                / <a href='@(Url.Action("Index",new{ParentDirId=new FunFilesHelper().RootDirId}))'>@(Localizer["root"])</a>
            </li>
        </ol>
    </nav>
</p>


<table class="table">
    <thead>
        <tr>
            <th>
                @(Html.DisplayNameFor(model => model.Name))
            </th>
            <th>
                @(Html.DisplayNameFor(model => model.DOCreating))
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody id="FileAndDir">
        @foreach (var item in Model) 
        {
            <tr item_id="@(item.Id)" class="FileAndDirTr">
                <td class="ItemName">
                    <a asp-action="Index" asp-route-ParentDirId='@(item.Id)'>
                        @(Html.DisplayFor(modelItem => item.Name))
                    </a>
                </td>
                <td>
                    @(item.DOCreating.LocalDateTime)
                </td>
                <td class="OperationEle">
                    
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts
{
    <script>
        $(document).ready(()=>{
            $.get(`@(Url.Action("GetPathBreadcrumb",new{ParentDirId}))`,(data)=>{$(`.PathBreadcrumb>ol`).append(data)});

            $.get(`@(Url.Action("IndexFunYourFiles",new{ParentDirId}))`,(data)=>{  $(`#FileAndDir`).append(data);   AddEleToOperationEle();  });

            $(document).on(`click`,`.FileAndDirTr`,(e)=>{ FileAndDir_Tr_Click(e);   });

            $(document).on(`contextmenu`,`.FileAndDirTr`,(e)=>{ FileAndDir_Tr_Click(e); return false;  });

            $(document).on(`click`,`.SubOperationEle`,(e)=>{FileAndDirOperation(e);});

        });

        function CopyAndMove(IsCopy=true){

        }

        /**
         * @@param {Event}e
         */
        function FileAndDirOperation(e){
            let _target=$(e.target);
            let item_id=_target.attr(`item_id`);
            
            if(_target.hasClass(`Copy`)){

            }else if(_target.has(`Move`)){

            }else if(_target.hasClass(`Details`)){

            }else if(_target.hasClass(`Delete`)){

            }else{
                //  rename
            }
        }


        /**
         * @@param {Event}e
         */
        function FileAndDir_Tr_Click(e){

            var item_id= $(e.target).parents('tr').attr(`item_id`);


            
            let OperationCard=$(`#card_${item_id}`);

            if(OperationCard.is(":visible")){

                OperationCard.hide();

            }else{

                $(`.item_operation_card`).hide();
                    
                OperationCard.show();

                let ItemOperationSpan=$(`#item_operation_span_${item_id}`);
                
                let ItemOperationSpan_top=Number(ItemOperationSpan.offset().top);
                let ItemOperationSpan_height=Number(ItemOperationSpan.height());

                let OperationCard_height=Number(OperationCard.height());

                let window_height=Number($(window).height());

                let ItemOperationSpan_left=Number(ItemOperationSpan.offset().left);
                let ItemOperationSpan_width=Number(ItemOperationSpan.width());

                let OperationCard_width=Number(OperationCard.width());

                let window_width=Number($(window).width());

                let _top=(ItemOperationSpan_top+OperationCard_height)>window_height?
                        (ItemOperationSpan_top-OperationCard_height):(ItemOperationSpan_top+ItemOperationSpan_height);

                let _left=(ItemOperationSpan_left+OperationCard_width)>window_width?
                        (ItemOperationSpan_left-OperationCard_width):(ItemOperationSpan_left+ItemOperationSpan_width);
                    
                OperationCard.offset({ top:_top,  left:_left  });

            }
            

        }

        function AddEleToOperationEle(){
            
            $(`.OperationEle`).each((index,elem)=>{
                var _item_id=$(elem).parent().attr(`item_id`);
                $(elem).append(`
                    <span id="item_operation_span_${_item_id}" >
                        ...
                    </span>
                    <div class="card card-body item_operation_card"  id="card_${_item_id}">
                        <div  item_id="${_item_id}" class='SubOperationEle Copy'>@(Localizer["Copy"])</div>  
                        <div  item_id="${_item_id}" class='SubOperationEle Rename'>@(Localizer["Rename"])</div> 
                        <div  item_id="${_item_id}" class='SubOperationEle Move'>@(Localizer["Move"])</div>   
                        <div  item_id="${_item_id}" class='SubOperationEle Details'>@(Localizer["Details"])</div>   
                        <div  item_id="${_item_id}" class='SubOperationEle Delete'>@(Localizer["Delete"])</div> 
                    </div>
                `);
            });
            
        }

    </script>
}

@section Styles
{
    <style>
        .ItemName{
            width: 20%;
            word-wrap: break-word;
            word-break: break-all;
        }

        .item_operation_card{
            display: none;
            position: absolute;
            text-align: center;
            color: blue;
            font-size: 18px;
        }

        .item_operation_card div{
            border-radius: 6px;
            padding: 2px;
            cursor: pointer;
            margin: 5px;
        }
        .item_operation_card div:hover{
            background-color: rgba(238,73,151,0.5);
            transform: scale(1.08);
        }
        

    </style>
}