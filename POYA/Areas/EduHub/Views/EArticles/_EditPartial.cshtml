@*
    For more information on enabling MVC for empty projects, visit http://go.microsoft.com/fwlink/?LinkID=397860
*@
@*
    ////////////////////////////////////////////////////////////////////////////////
    ////////                                                                ////////
    ////////        Keep in mind that JavaScript is a single-threaded       ////////
    ////////                programming language                            ////////
    ////////                                                                ////////
    ////////////////////////////////////////////////////////////////////////////////

*@

@using POYA.Areas.EduHub.Models;
@using POYA.Unities.Helpers;
@model POYA.Areas.EduHub.Models.EArticle

@{
    var IsEdit = (bool)ViewData["IsEdit"];
    var EArticleFiles = IsEdit ? ViewData["EArticleFiles"] as List<EArticleFile> : null;
    var FileRemoveEleString = "FileRemoveEle_";
    var IsVideoFileUploaded = IsEdit ? EArticleFiles.Any(p => p.IsEArticleVideo) : false;
    var _EditorPartialViewDataDictionary = new ViewDataDictionary(ViewData) { 
        { "MenuToolbar", "MenuToolbar" }, 
        { "ContentEditor", "_ContentEditor" }, 
        { "UploadFileName","EArticleImages"},
        { "UploadImgServer",Url.Action("UploadEArticleImage")}
    };
}

<div class="row">
    <div class="col">
        <form asp-action='@(IsEdit ? "Edit" : "Create")' id="EArticles_Form" name="EArticles_Form" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />
            <div class="form-group ">
                <div class="row">
                    <input asp-for="Title" class="form-control col offset-3 col-6" placeholder='@(Localizer["Title"])' autocomplete="off" />

                </div>
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <div id="MenuToolbar" class="toolbar">
                </div>
                <div id="_ContentEditor" class="text">
                    @(Html.Raw(Model.Content))
                </div>
                <span id="ContentValidation" class="text-danger"></span>
            </div>

            <div class="form-group ">
                <div class="row">
                    <div class="col col-3">
                        <select id="FirstCategorySelect" asp-items="Model.FirstCategorySelectListItems" class="form-control"></select>
                    </div>
                    <div class="col col-3">
                        <select asp-for="CategoryId" asp-items="Model.SecondCategorySelectListItems" class="form-control"></select>
                    </div>
                    <div class="col col-3">
                        <input asp-for="AdditionalCategory" class="form-control" />
                    </div>

                </div>
                <div class="row">
                    <div class="col col-3">
                        <span>@(Localizer["Complexity"])</span> ?
                        <span>
                            <select asp-for="ComplexityRank" asp-items="Model.ComplexityRankSelectListItems" class="form-control"></select>
                        </span>
                    </div>
                </div>
            </div>
            <div class="form-group offset-1">
                <div class="row">
                    <div class="col col-5" id="video_div">
                        <span class="row">@(Localizer["Upload videos for your article"])</span>
                        <div class="col" id="video_list_div">
                            @if (IsEdit)
                            {
                                foreach (var v in EArticleFiles.Where(p => p.IsEArticleVideo))
                                {
                                    var _id = v.Id.ToString();

                                    <div class="SelectFileShowEle row" id="@(FileRemoveEleString+_id)">
                                        <span>@(v.FileName)</span>
                                        <span class='FileInputRemoveEle' id="LVideos_@_id" onclick="RemoveFile('@_id',true,true)">  &#128500; </span>
                                    </div>
                                }
                            }
                        </div>
                        <div class="row" id="video_row_div">
                            <a class="btn btn-outline-info" id="VideoSelectEle">@(Localizer["Select video"])</a>
                        </div>
                    </div>
                    <div class="col offset-1 col-5" id="attachment_div">
                        <span class="row">@(Localizer["Upload attachments for your article"])</span>
                        <div class="col" id="attachment_list_div">
                            @if (IsEdit)
                            {
                                foreach (var a in EArticleFiles.Where(p => !p.IsEArticleVideo))
                                {
                                    var _id = a.Id.ToString();
                                    <div class="SelectFileShowEle row" id="@(FileRemoveEleString+_id)"><span>@(a.FileName)</span><span class='FileInputRemoveEle' id="LAttachments_@_id" onclick="RemoveFile('@_id',false,true)"> &#128500;</span></div>
                                }
                            }
                        </div>
                        <div class="row" id="attachment_row_div">
                            <a class="btn btn-outline-info" id="AttachmentSelectBtn">@(Localizer["Select attachment"])</a>
                        </div>

                    </div>
                </div>
            </div>

            <div class="form-group">
                <a id="BackA" class="btn btn-outline-primary">&laquo; @(Localizer["Back"])</a>
                <a class="btn btn-outline-info col-4" id="EArticles_Form_Submit_A">@(IsEdit ? Localizer["Save"] : Localizer["Publish"])</a>
                <a asp-action="Donate" asp-controller="Home" target="Donate">@(Localizer["Donate"])</a>
                <span id="SaveProgressEle"></span>
            </div>
        </form>
    </div>
</div>

<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/js-sha256/build/sha256.min.js"></script>
<partial name="_DefaultEditorPartial" view-data="_EditorPartialViewDataDictionary" />
<script>

    var IDAndSHA256Array = new Array();

    var IsVideoFileSelected =Boolean(`@(IsVideoFileUploaded?"":"0")`); 

    var LAttachmentFileInputId = (id) => `LAttachments_${id}`;

    var LVideoFileInputId = (id) => `LVideos_${id}`;

    var LAttachmentFileInput = (id) => `<input type='file' hidden name='LAttachments' id='${this.LAttachmentFileInputId(id)}' onchange='LAttachmentsOnChange("${id}")'/>`;

    var LVideoFileInput = (id) => `<input type='file'  hidden name='LVideos' id='${this.LVideoFileInputId(id)}' accept='video/*'  onchange='LVideosOnChange("${id}")'/>`;
    
    var FileRemoveEleId = (id) => `@FileRemoveEleString${id}`;

    var FileRemoveSpanId = (id) => `FileRemoveSpan_${id}`;

    $(document).ready(function () {

        $("#video_list_div").hide();
        
        $("#attachment_list_div").hide();

        HandleCategorySelect();

        $(document).on("change","#FirstCategorySelect", ()=>{ HandleCategorySelect();  });

        $(document).on("click","#_ContentEditor", ()=> {  $(".w-e-text").focus();  });

        $(document).on("mouseover","#attachment_div", ()=> {  $("#attachment_list_div").show();  });

        $(document).on("mouseout","#attachment_div", ()=> { $("#attachment_list_div").hide();  });

        $(document).on("mouseover","#video_div", ()=> {   $("#video_list_div").show();  });

        $(document).on("mouseout","#video_div", ()=> {  $("#video_list_div").hide();  });

        $(document).on("click","#EArticles_Form_Submit_A", ()=> { EArticles_Form_Submit_AClick(); });

        $(document).on("blur","#_ContentEditor *", ()=> {  _ContentEditorBlur(); });

        $(document).on("click","#VideoSelectEle",  ()=> { VideoSelectEleClick(); });

        $(document).on("click","#AttachmentSelectBtn",  ()=> { AttachmentSelectBtnClick() });

    });

    function AttachmentSelectBtnClick()
    {

        var _LastAttachmentInputVal = $("#attachment_row_div input:last").val();

        if (_LastAttachmentInputVal == undefined || _LastAttachmentInputVal.length > 0) {
            let _LAttachmentFileInput = LAttachmentFileInput(_Data_.NewGuid());
            $(_LAttachmentFileInput).attr("form", "EArticles_Form");
            $("#attachment_row_div").append(_LAttachmentFileInput);
        }
        $("#attachment_row_div input:last").click();

        event.preventDefault();

    }

    function VideoSelectEleClick()
    {
        if (IsVideoFileSelected) return;
        var _LastVideoInputVal = $("#video_row_div input:last").val();
        if (_LastVideoInputVal == undefined || _LastVideoInputVal.length > 0) {

            let _LVideoFileInput = LVideoFileInput(_Data_.NewGuid());
            
            $(_LVideoFileInput).attr("form", "EArticles_Form");

            $("#video_row_div").append(_LVideoFileInput);

        }
        $("#video_row_div input:last").click();

        event.preventDefault();

    }

    function _ContentEditorBlur()
    { 
        if (Editor.txt.html().length < 20) {
            $("#ContentValidation").html(`@(Localizer["The content of the article should be more than 20 characters"])!`);
        } else {
            $("#ContentValidation").html("");
        }

    }

    function EArticles_Form_Submit_AClick()
    {
        if ($("#Title").val().length < 2) return;
        if (Editor.txt.html().length < 10) return;
        CheckSHA256();
        event.preventDefault();

    }

    /**
     *  public Guid EArticleId { get; set; }
     *  public string FileName { get; set;}
     *  public string SHA256 { get; set; }
     *  public bool IsEArticleVideo { get; set; } = false;
     * */
    function SubmitForm(Editor) {
        let _EArticles_Form_Data_ = new FormData();
        _EArticles_Form_Data_.append("@(nameof(Model.Title))", $("#@nameof(Model.Title)").val());
        _EArticles_Form_Data_.append("@(nameof(Model.Content))", Editor.txt.html());
        _EArticles_Form_Data_.append("@(nameof(Model.Id))", "@Model.Id");
        _EArticles_Form_Data_.append("@(nameof(Model.CategoryId))", $("#CategoryId option:selected").val().toString().split('_')[0]);
        _EArticles_Form_Data_.append("@(nameof(Model.ComplexityRank))", $("#ComplexityRank option:selected").val());
        _EArticles_Form_Data_.append("@(nameof(Model.AdditionalCategory))", $("#AdditionalCategory").val());

        $("input[name='LAttachments']").each(function (index, elem) {

            if ($(elem).val() == "") return true;
            let _id = this.id;
            
            let _File = document.getElementById(_id).files[0];
            _EArticles_Form_Data_.append("LAttachments", _File, _File.name);
        });
        $("input[name='LVideos']").each(function (index, elem) {
            
            if ($(elem).val() == "") return true;
            let _id = this.id;
            let _File = document.getElementById(_id).files[0];
            _EArticles_Form_Data_.append("LVideos", _File, _File.name);
        });
        $.ajax({
            url: `@(Url.Action(IsEdit?"Edit":"Create"))`,
            type: "POST",
            data: _EArticles_Form_Data_,
            processData: false,
            contentType: false,
            async: true,
            headers: {  "@(X_DOVEValues.CustomHeaderName)": "@(csrf.GetAndStoreTokens(Context).RequestToken)"  },
            /**
             * REFERENCE    https://www.jianshu.com/p/eb119affdc25
             * THANK        https://www.jianshu.com/u/9ca9c65ce397
             */
            xhr: function () {
                var xhr = $.ajaxSettings.xhr();
                if (xhr.upload) {
                    xhr.upload.addEventListener("progress", function (e) {
                        
                        var loaded = e.loaded;

                        var tot = e.total;
                        
                        var per = Math.floor(100 * loaded / tot);
                        
                        $("#SaveProgressEle").html(per + "%");
                    }, false);
                    return xhr;
                }
            },
            /**
             * Retuen the id
             * @@param {number} Id The id
             */
            success: ()=> { history.go(-1); }
        });


    }

    var _CategoryId = "@Model.CategoryId";
    var _GuidEmpty = "@(Guid.Empty)";
    var _IsEdit =Boolean(`@IsEdit?"":"0"`);  
    function HandleCategorySelect() {

        if (_CategoryId != _GuidEmpty) {
            var _SecondCategoryCode = $("#CategoryId option:selected").val().toString().split('_')[1];
            $("#FirstCategorySelect option").each((index, element) => {
                var _FirstCategoryCode = $(element).val().toString().split('_')[1];
                if (_SecondCategoryCode.startsWith(_FirstCategoryCode)) {

                    $(element).attr("selected", true);
                    return false;
                }
            });
        } else {
            var _FirstCategoryCode = $("#FirstCategorySelect option:selected").val().toString().split('_')[1];
            var IsSetSelected = false;
            $("#CategoryId option").each((index, element) => {
                var _SecondCategoryCode = $(element).val().toString().split('_')[1];
                if (_SecondCategoryCode.startsWith(_FirstCategoryCode)) {
                    $(element).show();
                    if (!IsSetSelected) {
                        $(element).attr("selected", true);
                        IsSetSelected = true;
                    }
                } else {
                    $(element).hide();
                }
            });
        }

    }

    /**
     *
     * @@param {string} id -The id
     * @@param {boolean} IsVideoFileInput -Flag a file input is video input for article
     * @@param {boolean} IsUploadedFile -Flag a file input is uploaded(from Edit)
     */
    function RemoveFile(id, IsVideoFileInput = false, IsUploadedFile = false) {
        if (IsUploadedFile) {
            $.ajax({
                url: `@Url.Action("RemoveArticleFile")`,
                type: "POST",
                data: { "id": id },
                headers: {  "@(X_DOVEValues.CustomHeaderName)": "@(csrf.GetAndStoreTokens(Context).RequestToken)"  },
                success:  ()=> {
                    $(`#${FileRemoveEleId(id)}`).remove();
                    IsVideoFileSelected = false;
                }
            });
        } else {
            $(`#${FileRemoveEleId(id)}`).remove();
            if (IsVideoFileInput) {
                $(`#${LVideoFileInputId(id)}`).remove();
            } else {
                $(`#${LAttachmentFileInputId(id)}`).remove();
            }
            IsVideoFileSelected = false;
        }

    }

    function LAttachmentsOnChange(id) {
        GetSHA256(LAttachmentFileInputId(id), false);
        let _Value = $(`#LAttachments_${id}`).val();
        let _Content = `<div class="SelectFileShowEle" title='@(Localizer["Delete"])'  id="${FileRemoveEleId(id)}" ><span>${_Value}</span><span class='FileInputRemoveEle'  id="${FileRemoveSpanId(id)}" onclick="RemoveFile('${id}')"> x</span></div>`;
        $("#attachment_list_div").append(_Content);
    }

    function LVideosOnChange(id) {
        GetSHA256(LVideoFileInputId(id),true);
        let _Value = $(`#LVideos_${id}`).val();
        let _Content = `<div class="SelectFileShowEle"   title='@Localizer["Delete"]'  id="${FileRemoveEleId(id)}" ><span>${_Value}</span><span class='FileInputRemoveEle'   id="${FileRemoveSpanId(id)}" onclick="RemoveFile('${id}',true)"> x</span></div>`;
        $("#video_list_div").append(_Content);
        IsVideoFileSelected = true;
    }
    
    /**
     * Get SHA256 of file input and execute a function
     * @@param {string} Id -The id of file input
     * @@param {Function} ToDo - Execute a function(pass Id and SHA256) after finishing computing SHA256
     * @@param {boolean} IsEArticleVideo - Flag a file is video of article or not, the default is false
     */
    function GetSHA256(Id,  IsEArticleVideo = false) {

        var File_ = File_ = document.getElementById(Id).files[0];
        
        $("#SaveProgressEle").html(`@Localizer["Read file"] . . .`);

        let _FileReader = new FileReader();

        $(`[file_input_id='${_id}']`).html(_FileName+` [@(Localizer["Read"]) . . .]`);
        
        _FileReader.readAsArrayBuffer( File_ );

        _FileReader.onload = ()=>{
            
            let _SHA256 = sha256(_FileReader.result).toString();

            $("#SaveProgressEle").html(`@Localizer["Read file finish"]`);

            if (!IDAndSHA256Array.some((value, index, array) => { value["ID"] == Id && value["SHA256"] == _SHA256 })) {
                IDAndSHA256Array.push({ "ID": Id, "SHA256": _SHA256, "IsEArticleVideo": IsEArticleVideo });
            }
            setTimeout(function () {

                $("#SaveProgressEle").html("");

            },2000);
            

            if(index==_LastIndex){
                CompareSHA256();
            }
        };

    }


    function CheckSHA256() {
        if (IDAndSHA256Array.length < 1) SubmitForm(Editor);
        var eArticleFileSHA256s = new Array();

        IDAndSHA256Array.forEach((value, index, array) => {
            eArticleFileSHA256s.push({
                FileInputId:"",
                EArticleId: "@Model.Id",
                FileName: $("#" + value["ID"]).val(),
                SHA256: value["SHA256"],
                IsEArticleVideo: value["IsEArticleVideo"]
            });
        });

        $.ajax({
            url: `@Url.Action("LCheckSHA256v1")`,
            type: "POST",
            data: { eArticleFileMD5s: eArticleFileMD5s },

            headers: {
                "@(X_DOVEValues.CustomHeaderName)": "@(csrf.GetAndStoreTokens(Context).RequestToken)"
            },
            dataType: "json",
            success: function (Response) {
                Response.forEach((value, index, array) => {

                    if (value["IsUploaded"] == true) {
                        IDAndSHA256Array.forEach((v, i, a) => {
                            if (v["SHA256"] == value["FileSHA256"]) {
                                $(`#${v["ID"]}`).remove();
                            }
                        });
                    }
                });
                SubmitForm(Editor);
            }
        });

    }


</script>

<style>

    #Title {
        text-align: center;
    }

    .LookForImageIcon {
        zoom: 200%;
    }

    .SelectFileShowEle {
        border: dotted;
        border-radius: 8px;
        padding: 2px;
        max-width: 90%;
        word-break: break-all;
        word-wrap: break-word;
    }

    .FileInputRemoveEle:hover {
        color: red;
        zoom: 150%;
    }
</style>


